<?php

namespace Tests\Integration;

use Tests\TestCase;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Illuminate\Foundation\Testing\WithFaker;

/**
 * REST API Integration Tests
 * 
 * Tests API endpoints for {FEATURE_NAME}
 * Framework: PHPUnit with Laravel
 * 
 * Generated by: /gbm.qa.scaffold-tests
 */
class {Resource}ApiTest extends TestCase
{
    use RefreshDatabase, WithFaker;
    
    protected function setUp(): void
    {
        parent::setUp();
        
        // Setup: Initialize test database
        // TODO: Seed any required base data
    }
    
    /**
     * @test
     */
    public function it_returns_list_of_{resource}()
    {
        // Arrange
        // TODO: Create test {resource}s
        $this->create{Resource}(['name' => 'Test 1']);
        $this->create{Resource}(['name' => 'Test 2']);
        
        // Act
        $response = $this->getJson('/api/{resource}');
        
        // Assert
        $response->assertStatus(200)
                 ->assertJsonStructure([
                     'data' => [
                         '*' => ['id', 'name', 'created_at', 'updated_at']
                     ]
                 ])
                 ->assertJsonCount(2, 'data');
    }
    
    /**
     * @test
     */
    public function it_returns_empty_array_when_no_{resource}_exist()
    {
        // Act
        $response = $this->getJson('/api/{resource}');
        
        // Assert
        $response->assertStatus(200)
                 ->assertJson(['data' => []]);
    }
    
    /**
     * @test
     */
    public function it_filters_{resource}_by_query_parameters()
    {
        // Arrange
        $this->create{Resource}(['name' => 'Active', 'status' => 'active']);
        $this->create{Resource}(['name' => 'Inactive', 'status' => 'inactive']);
        
        // Act
        $response = $this->getJson('/api/{resource}?status=active');
        
        // Assert
        $response->assertStatus(200)
                 ->assertJsonCount(1, 'data')
                 ->assertJsonPath('data.0.status', 'active');
    }
    
    /**
     * @test
     */
    public function it_returns_single_{resource}_by_id()
    {
        // Arrange
        ${resource} = $this->create{Resource}(['name' => 'Test {Resource}']);
        
        // Act
        $response = $this->getJson("/api/{resource}/{${resource}->id}");
        
        // Assert
        $response->assertStatus(200)
                 ->assertJson([
                     'data' => [
                         'id' => ${resource}->id,
                         'name' => ${resource}->name,
                     ]
                 ]);
    }
    
    /**
     * @test
     */
    public function it_returns_404_for_non_existent_{resource}()
    {
        // Act
        $response = $this->getJson('/api/{resource}/99999');
        
        // Assert
        $response->assertStatus(404)
                 ->assertJson([
                     'message' => 'Not found'
                 ]);
    }
    
    /**
     * @test
     */
    public function it_creates_new_{resource}_with_valid_data()
    {
        // Arrange
        $data = [
            'name' => 'New {Resource}',
            // TODO: Add required fields
        ];
        
        // Act
        $response = $this->postJson('/api/{resource}', $data);
        
        // Assert
        $response->assertStatus(201)
                 ->assertJsonStructure([
                     'data' => ['id', 'name', 'created_at']
                 ])
                 ->assertJsonPath('data.name', $data['name']);
        
        $this->assertDatabaseHas('{resource}', [
            'name' => $data['name']
        ]);
    }
    
    /**
     * @test
     */
    public function it_returns_422_for_invalid_data()
    {
        // Arrange
        $invalidData = [
            // TODO: Missing required fields
        ];
        
        // Act
        $response = $this->postJson('/api/{resource}', $invalidData);
        
        // Assert
        $response->assertStatus(422)
                 ->assertJsonValidationErrors(['name']); // Adjust field names
    }
    
    /**
     * @test
     */
    public function it_validates_required_fields()
    {
        // Act
        $response = $this->postJson('/api/{resource}', []);
        
        // Assert
        $response->assertStatus(422)
                 ->assertJsonValidationErrors(['name']); // Add all required fields
    }
    
    /**
     * @test
     */
    public function it_validates_field_formats()
    {
        // Arrange
        $data = [
            'name' => 'Test',
            'email' => 'invalid-email', // Invalid format
        ];
        
        // Act
        $response = $this->postJson('/api/{resource}', $data);
        
        // Assert
        $response->assertStatus(422)
                 ->assertJsonValidationErrors(['email']);
    }
    
    /**
     * @test
     */
    public function it_enforces_unique_constraints()
    {
        // Arrange
        $data = [
            'name' => 'Unique Test',
            'email' => 'unique@example.com',
        ];
        
        $this->postJson('/api/{resource}', $data);
        
        // Act - Try to create duplicate
        $response = $this->postJson('/api/{resource}', $data);
        
        // Assert
        $response->assertStatus(422)
                 ->assertJsonValidationErrors(['email']);
    }
    
    /**
     * @test
     */
    public function it_updates_existing_{resource}()
    {
        // Arrange
        ${resource} = $this->create{Resource}(['name' => 'Original']);
        $updateData = ['name' => 'Updated'];
        
        // Act
        $response = $this->putJson("/api/{resource}/{${resource}->id}", $updateData);
        
        // Assert
        $response->assertStatus(200)
                 ->assertJsonPath('data.name', 'Updated');
        
        $this->assertDatabaseHas('{resource}', [
            'id' => ${resource}->id,
            'name' => 'Updated'
        ]);
    }
    
    /**
     * @test
     */
    public function it_returns_404_when_updating_non_existent_{resource}()
    {
        // Act
        $response = $this->putJson('/api/{resource}/99999', ['name' => 'Updated']);
        
        // Assert
        $response->assertStatus(404);
    }
    
    /**
     * @test
     */
    public function it_partially_updates_{resource}_with_patch()
    {
        // Arrange
        ${resource} = $this->create{Resource}([
            'name' => 'Original',
            'description' => 'Original Description'
        ]);
        
        // Act
        $response = $this->patchJson("/api/{resource}/{${resource}->id}", [
            'name' => 'Updated'
        ]);
        
        // Assert
        $response->assertStatus(200)
                 ->assertJsonPath('data.name', 'Updated')
                 ->assertJsonPath('data.description', 'Original Description');
    }
    
    /**
     * @test
     */
    public function it_deletes_existing_{resource}()
    {
        // Arrange
        ${resource} = $this->create{Resource}();
        
        // Act
        $response = $this->deleteJson("/api/{resource}/{${resource}->id}");
        
        // Assert
        $response->assertStatus(204);
        
        $this->assertDatabaseMissing('{resource}', [
            'id' => ${resource}->id
        ]);
    }
    
    /**
     * @test
     */
    public function it_returns_404_when_deleting_non_existent_{resource}()
    {
        // Act
        $response = $this->deleteJson('/api/{resource}/99999');
        
        // Assert
        $response->assertStatus(404);
    }
    
    /**
     * @test
     */
    public function it_paginates_{resource}_list()
    {
        // Arrange
        for ($i = 0; $i < 25; $i++) {
            $this->create{Resource}(['name' => "Test {$i}"]);
        }
        
        // Act
        $response = $this->getJson('/api/{resource}?page=1&per_page=10');
        
        // Assert
        $response->assertStatus(200)
                 ->assertJsonCount(10, 'data')
                 ->assertJsonStructure([
                     'data',
                     'meta' => ['current_page', 'total', 'per_page']
                 ]);
    }
    
    /**
     * @test
     */
    public function it_sorts_{resource}_by_field()
    {
        // Arrange
        $this->create{Resource}(['name' => 'Charlie']);
        $this->create{Resource}(['name' => 'Alice']);
        $this->create{Resource}(['name' => 'Bob']);
        
        // Act
        $response = $this->getJson('/api/{resource}?sort=name&order=asc');
        
        // Assert
        $response->assertStatus(200)
                 ->assertJsonPath('data.0.name', 'Alice')
                 ->assertJsonPath('data.1.name', 'Bob')
                 ->assertJsonPath('data.2.name', 'Charlie');
    }
    
    /**
     * @test
     */
    public function it_requires_authentication()
    {
        // Act
        $response = $this->getJson('/api/{resource}');
        
        // Assert
        // TODO: Adjust based on your auth strategy
        // $response->assertStatus(401);
    }
    
    /**
     * @test
     */
    public function it_allows_access_with_valid_token()
    {
        // Arrange
        $user = $this->createUser();
        $token = $user->createToken('test-token')->plainTextToken;
        
        // Act
        $response = $this->withHeader('Authorization', "Bearer {$token}")
                         ->getJson('/api/{resource}');
        
        // Assert
        $response->assertStatus(200);
    }
    
    /**
     * @test
     */
    public function it_handles_server_errors_gracefully()
    {
        // Arrange
        // TODO: Mock a service to throw exception
        
        // Act
        $response = $this->getJson('/api/{resource}');
        
        // Assert
        $response->assertStatus(500)
                 ->assertJson([
                     'message' => 'Server Error'
                 ]);
    }
    
    /**
     * Helper method to create {resource}
     */
    protected function create{Resource}(array $attributes = []): {Resource}
    {
        return {Resource}::factory()->create($attributes);
    }
    
    /**
     * Helper method to create user
     */
    protected function createUser(array $attributes = []): User
    {
        return User::factory()->create($attributes);
    }
}


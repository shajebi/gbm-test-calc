name: Release Please

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
      pr: ${{ steps.release.outputs.pr }}
    steps:
      - name: Run Release Please
        id: release
        uses: googleapis/release-please-action@v4
        with:
          config-file: .augment/.release-please-config.json
          manifest-file: .augment/.release-please-manifest.json
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Show Release Please outputs
        if: steps.release.outputs.pr
        run: |
          echo "Release Please created a PR"
          echo "Release created: ${{ steps.release.outputs.release_created }}"
          if [ "${{ steps.release.outputs.release_created }}" == "true" ]; then
            echo "New release: ${{ steps.release.outputs.tag_name }}"
            echo "Version: ${{ steps.release.outputs.version }}"
          fi

  # Template release - no publishing, just documentation and validation
  template-release:
    needs: release-please
    if: needs.release-please.outputs.release_created == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate template structure
        run: |
          echo "ðŸ” Validating template structure..."

          # Check essential files exist
          for file in "README.md" "AGENTS.md" "Makefile" "LICENSE" "CONTRIBUTING.md"; do
            if [[ -f "$file" ]]; then
              echo "âœ… $file exists"
            else
              echo "âŒ $file missing"
              exit 1
            fi
          done

          # Check template files exist
          for template in ".augment/templates/pyproject.toml.example" ".augment/templates/package.json.example"; do
            if [[ -f "$template" ]]; then
              echo "âœ… $template exists"
            else
              echo "âŒ $template missing"
              exit 1
            fi
          done

          # Check workflow files exist
          for workflow in ".github/workflows/ci.yml" ".github/workflows/release.yml" ".github/workflows/security.yml"; do
            if [[ -f "$workflow" ]]; then
              echo "âœ… $workflow exists"
            else
              echo "âŒ $workflow missing"
              exit 1
            fi
          done

      - name: Test template functionality
        run: |
          echo "ðŸ§ª Testing template functionality..."

          # Test Makefile targets
          make help

          # Test Python template
          echo "Testing Python template..."
          cp .augment/templates/pyproject.toml.example test-pyproject.toml
          if grep -q "your-project-name" test-pyproject.toml; then
            echo "âœ… Python template contains placeholder values"
          else
            echo "âŒ Python template missing placeholders"
            exit 1
          fi
          rm test-pyproject.toml

          # Test Node.js template
          echo "Testing Node.js template..."
          cp .augment/templates/package.json.example test-package.json
          if grep -q "your-project-name" test-package.json; then
            echo "âœ… Node.js template contains placeholder values"
          else
            echo "âŒ Node.js template missing placeholders"
            exit 1
          fi
          rm test-package.json

      - name: Generate release documentation
        run: |
          echo "ðŸ“ Generating release documentation..."

          # Create release notes with template usage instructions
          cat > RELEASE_NOTES.md << 'EOF'
          # Augment Template Release ${{ needs.release-please.outputs.tag_name }}

          ## ðŸš€ How to Use This Template

          ### Quick Start
          1. Click "Use this template" on GitHub
          2. Clone your new repository
          3. Copy template files:
             ```bash
             # For Python projects
             cp .augment/templates/pyproject.toml.example pyproject.toml

             # For Node.js projects
             cp .augment/templates/package.json.example package.json
             ```
          4. Start developing:
             ```bash
             make install
             make dev
             ```

          ### What's Included
          - âœ… Auto-detecting CI/CD for Python and Node.js
          - âœ… Comprehensive code quality checks
          - âœ… Security scanning and vulnerability detection
          - âœ… Feature branch workflow with quality gates
          - âœ… Automated changelog generation
          - âœ… Augment Code integration and AI assistance

          ### Documentation
          - [Quick Start Guide](README.md)
          - [Complete Documentation](.augment/README.md)
          - [Development Guidelines](AGENTS.md)
          - [Contributing Guide](CONTRIBUTING.md)

          ## ðŸ”§ Template Validation
          This release has been validated to ensure:
          - All essential files are present
          - Template files contain proper placeholders
          - Makefile targets work correctly
          - CI/CD workflows are functional
          - Documentation is complete and accurate

          ## ðŸ“Š Release Statistics
          - Template files: $(find .augment/templates -name "*.example" | wc -l)
          - Workflow files: $(find .github/workflows -name "*.yml" | wc -l)
          - Documentation files: $(find .augment/docs -name "*.md" | wc -l)
          - Rule files: $(find .augment/rules -name "*.md" | wc -l)
          EOF

      - name: Create Release Summary
        run: |
          echo "## ðŸŽ‰ Template Release ${{ needs.release-please.outputs.tag_name }} Published!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Template Features:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ Python project support with uv" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ Node.js project support with auto-detection" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”„ Comprehensive CI/CD workflows" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ›¡ï¸ Security scanning and quality checks" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ¤– Augment Code integration" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“ Specification Driven Development" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Links:" >> $GITHUB_STEP_SUMMARY
          echo "- [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/${{ needs.release-please.outputs.tag_name }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Template Documentation](.augment/README.md)" >> $GITHUB_STEP_SUMMARY
          echo "- [Quick Start Guide](README.md)" >> $GITHUB_STEP_SUMMARY
